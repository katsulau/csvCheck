const AWS = require('aws-sdk');

AWS.config.update({ region: 'ap-northeast-1' });
const s3 = new AWS.S3();


exports.handler = async (event) => {

    const targetDataList = [
        "2021-09-10T16:00:00.184Z","2021-09-11T16:00:00.184Z","2021-09-12T16:00:00.184Z","2021-09-13T16:00:00.184Z","2021-09-14T16:00:00.184Z","2021-09-15T16:00:00.184Z","2021-09-16T16:00:00.184Z","2021-09-17T16:00:00.184Z","2021-09-18T16:00:00.184Z","2021-09-19T16:00:00.184Z","2021-09-20T16:00:00.184Z","2021-09-21T16:00:00.184Z","2021-09-22T16:00:00.184Z","2021-09-23T16:00:00.184Z","2021-09-24T16:00:00.184Z","2021-09-25T16:00:00.184Z","2021-09-26T16:00:00.184Z","2021-09-27T16:00:00.184Z","2021-09-28T16:00:00.184Z","2021-09-29T16:00:00.184Z","2021-09-30T16:00:00.184Z","2021-10-01T16:00:00.184Z","2021-10-02T16:00:00.184Z","2021-10-03T16:00:00.184Z","2021-10-04T16:00:00.184Z","2021-10-05T16:00:00.184Z","2021-10-06T16:00:00.184Z","2021-10-07T16:00:00.184Z","2021-10-08T16:00:00.184Z","2021-10-09T16:00:00.184Z","2021-10-10T16:00:00.184Z","2021-10-11T16:00:00.184Z","2021-10-12T16:00:00.184Z","2021-10-13T16:00:00.184Z","2021-10-14T16:00:00.184Z","2021-10-15T16:00:00.184Z","2021-10-16T16:00:00.184Z","2021-10-17T16:00:00.184Z","2021-10-18T16:00:00.184Z","2021-10-19T16:00:00.184Z","2021-10-20T16:00:00.184Z","2021-10-21T16:00:00.184Z","2021-10-22T16:00:00.184Z","2021-10-23T16:00:00.184Z","2021-10-24T16:00:00.184Z","2021-10-25T16:00:00.184Z","2021-10-26T16:00:00.184Z","2021-10-27T16:00:00.184Z","2021-10-28T16:00:00.184Z","2021-10-29T16:00:00.184Z","2021-10-30T16:00:00.184Z","2021-10-31T16:00:00.184Z","2021-11-01T16:00:00.184Z","2021-11-02T16:00:00.184Z","2021-11-03T16:00:00.184Z","2021-11-04T16:00:00.184Z","2021-11-05T16:00:00.184Z","2021-11-06T16:00:00.184Z","2021-11-07T16:00:00.184Z","2021-11-08T16:00:00.184Z","2021-11-09T16:00:00.184Z","2021-11-10T16:00:00.184Z","2021-11-11T16:00:00.184Z","2021-11-12T16:00:00.184Z","2021-11-13T16:00:00.184Z","2021-11-14T16:00:00.184Z","2021-11-15T16:00:00.184Z","2021-11-16T16:00:00.184Z","2021-11-17T16:00:00.184Z","2021-11-18T16:00:00.184Z","2021-11-19T16:00:00.184Z","2021-11-20T16:00:00.184Z","2021-11-21T16:00:00.184Z","2021-11-22T16:00:00.184Z","2021-11-23T16:00:00.184Z","2021-11-24T16:00:00.184Z","2021-11-25T16:00:00.184Z","2021-11-26T16:00:00.184Z","2021-11-27T16:00:00.184Z","2021-11-28T16:00:00.184Z","2021-11-29T16:00:00.184Z","2021-11-30T16:00:00.184Z","2021-12-01T16:00:00.184Z","2021-12-02T16:00:00.184Z","2021-12-03T16:00:00.184Z","2021-12-04T16:00:00.184Z","2021-12-05T16:00:00.184Z","2021-12-06T16:00:00.184Z","2021-12-07T16:00:00.184Z","2021-12-08T16:00:00.184Z","2021-12-09T16:00:00.184Z","2021-12-10T16:00:00.184Z","2021-12-11T16:00:00.184Z","2021-12-12T16:00:00.184Z","2021-12-13T16:00:00.184Z","2021-12-14T16:00:00.184Z","2021-12-15T16:00:00.184Z","2021-12-16T16:00:00.184Z","2021-12-17T16:00:00.184Z","2021-12-18T16:00:00.184Z","2021-12-19T16:00:00.184Z","2021-12-20T16:00:00.184Z","2021-12-21T16:00:00.184Z","2021-12-22T16:00:00.184Z","2021-12-23T16:00:00.184Z","2021-12-24T16:00:00.184Z","2021-12-25T16:00:00.184Z","2021-12-26T16:00:00.184Z","2021-12-27T16:00:00.184Z","2021-12-28T16:00:00.184Z","2021-12-29T16:00:00.184Z","2021-12-30T16:00:00.184Z","2021-12-31T16:00:00.184Z","2022-01-01T16:00:00.184Z","2022-01-02T16:00:00.184Z","2022-01-03T16:00:00.184Z","2022-01-04T16:00:00.184Z","2022-01-05T16:00:00.184Z","2022-01-06T16:00:00.184Z","2022-01-07T16:00:00.184Z","2022-01-08T16:00:00.184Z","2022-01-09T16:00:00.184Z","2022-01-10T16:00:00.184Z","2022-01-11T16:00:00.184Z","2022-01-12T16:00:00.184Z","2022-01-13T16:00:00.184Z","2022-01-14T16:00:00.184Z","2022-01-15T16:00:00.184Z","2022-01-16T16:00:00.184Z","2022-01-17T16:00:00.184Z","2022-01-18T16:00:00.184Z","2022-01-19T16:00:00.184Z","2022-01-20T16:00:00.184Z","2022-01-21T16:00:00.184Z","2022-01-22T16:00:00.184Z","2022-01-23T16:00:00.184Z","2022-01-24T16:00:00.184Z","2022-01-25T16:00:00.184Z","2022-01-26T16:00:00.184Z","2022-01-27T16:00:00.184Z","2022-01-28T16:00:00.184Z","2022-01-29T16:00:00.184Z","2022-01-30T16:00:00.184Z","2022-01-31T16:00:00.184Z","2022-02-01T16:00:00.184Z","2022-02-02T16:00:00.184Z","2022-02-03T16:00:00.184Z","2022-02-04T16:00:00.184Z","2022-02-05T16:00:00.184Z","2022-02-06T16:00:00.184Z","2022-02-07T16:00:00.184Z","2022-02-08T16:00:00.184Z","2022-02-09T16:00:00.184Z","2022-02-10T16:00:00.184Z","2022-02-11T16:00:00.184Z","2022-02-12T16:00:00.184Z","2022-02-13T16:00:00.184Z","2022-02-14T16:00:00.184Z","2022-02-15T16:00:00.184Z","2022-02-16T16:00:00.184Z","2022-02-17T16:00:00.184Z","2022-02-18T16:00:00.184Z","2022-02-19T16:00:00.184Z","2022-02-20T16:00:00.184Z","2022-02-21T16:00:00.184Z","2022-02-22T16:00:00.184Z","2022-02-23T16:00:00.184Z","2022-02-24T16:00:00.184Z","2022-02-25T16:00:00.184Z","2022-02-26T16:00:00.184Z","2022-02-27T16:00:00.184Z","2022-02-28T16:00:00.184Z","2022-03-01T16:00:00.184Z","2022-03-02T16:00:00.184Z","2022-03-03T16:00:00.184Z","2022-03-04T16:00:00.184Z","2022-03-05T16:00:00.184Z","2022-03-06T16:00:00.184Z","2022-03-07T16:00:00.184Z","2022-03-08T16:00:00.184Z","2022-03-09T16:00:00.184Z","2022-03-10T16:00:00.184Z","2022-03-11T16:00:00.184Z","2022-03-12T16:00:00.184Z","2022-03-13T16:00:00.184Z","2022-03-14T16:00:00.184Z","2022-03-15T16:00:00.184Z","2022-03-16T16:00:00.184Z","2022-03-17T16:00:00.184Z","2022-03-18T16:00:00.184Z","2022-03-19T16:00:00.184Z","2022-03-20T16:00:00.184Z","2022-03-21T16:00:00.184Z","2022-03-22T16:00:00.184Z","2022-03-23T16:00:00.184Z","2022-03-24T16:00:00.184Z","2022-03-25T16:00:00.184Z","2022-03-26T16:00:00.184Z","2022-03-27T16:00:00.184Z","2022-03-28T16:00:00.184Z","2022-03-29T16:00:00.184Z","2022-03-30T16:00:00.184Z","2022-03-31T16:00:00.184Z","2022-04-01T16:00:00.184Z","2022-04-02T16:00:00.184Z","2022-04-03T16:00:00.184Z","2022-04-04T16:00:00.184Z","2022-04-05T16:00:00.184Z","2022-04-06T16:00:00.184Z","2022-04-07T16:00:00.184Z","2022-04-08T16:00:00.184Z","2022-04-09T16:00:00.184Z","2022-04-10T16:00:00.184Z","2022-04-11T16:00:00.184Z","2022-04-12T16:00:00.184Z","2022-04-13T16:00:00.184Z","2022-04-14T16:00:00.184Z","2022-04-15T16:00:00.184Z","2022-04-16T16:00:00.184Z","2022-04-17T16:00:00.184Z","2022-04-18T16:00:00.184Z","2022-04-19T16:00:00.184Z","2022-04-20T16:00:00.184Z","2022-04-21T16:00:00.184Z","2022-04-22T16:00:00.184Z","2022-04-23T16:00:00.184Z","2022-04-24T16:00:00.184Z","2022-04-25T16:00:00.184Z","2022-04-26T16:00:00.184Z","2022-04-27T16:00:00.184Z","2022-04-28T16:00:00.184Z","2022-04-29T16:00:00.184Z","2022-04-30T16:00:00.184Z","2022-05-01T16:00:00.184Z","2022-05-02T16:00:00.184Z","2022-05-03T16:00:00.184Z","2022-05-04T16:00:00.184Z","2022-05-05T16:00:00.184Z","2022-05-06T16:00:00.184Z","2022-05-07T16:00:00.184Z","2022-05-08T16:00:00.184Z","2022-05-09T16:00:00.184Z","2022-05-10T16:00:00.184Z","2022-05-11T16:00:00.184Z","2022-05-12T16:00:00.184Z","2022-05-13T16:00:00.184Z","2022-05-14T16:00:00.184Z","2022-05-15T16:00:00.184Z","2022-05-16T16:00:00.184Z","2022-05-17T16:00:00.184Z","2022-05-18T16:00:00.184Z","2022-05-19T16:00:00.184Z","2022-05-20T16:00:00.184Z","2022-05-21T16:00:00.184Z","2022-05-22T16:00:00.184Z","2022-05-23T16:00:00.184Z","2022-05-24T16:00:00.184Z","2022-05-25T16:00:00.184Z","2022-05-26T16:00:00.184Z","2022-05-27T16:00:00.184Z","2022-05-28T16:00:00.184Z","2022-05-29T16:00:00.184Z","2022-05-30T16:00:00.184Z","2022-05-31T16:00:00.184Z","2022-06-01T16:00:00.184Z","2022-06-02T16:00:00.184Z","2022-06-03T16:00:00.184Z","2022-06-04T16:00:00.184Z","2022-06-05T16:00:00.184Z","2022-06-06T16:00:00.184Z","2022-06-07T16:00:00.184Z","2022-06-08T16:00:00.184Z","2022-06-09T16:00:00.184Z","2022-06-10T16:00:00.184Z","2022-06-11T16:00:00.184Z","2022-06-12T16:00:00.184Z","2022-06-13T16:00:00.184Z","2022-06-14T16:00:00.184Z","2022-06-15T16:00:00.184Z","2022-06-16T16:00:00.184Z","2022-06-17T16:00:00.184Z","2022-06-18T16:00:00.184Z","2022-06-19T16:00:00.184Z","2022-06-20T16:00:00.184Z","2022-06-21T16:00:00.184Z","2022-06-22T16:00:00.184Z","2022-06-23T16:00:00.184Z","2022-06-24T16:00:00.184Z","2022-06-25T16:00:00.184Z","2022-06-26T16:00:00.184Z","2022-06-27T16:00:00.184Z","2022-06-28T16:00:00.184Z","2022-06-29T16:00:00.184Z","2022-06-30T16:00:00.184Z","2022-07-01T16:00:00.184Z","2022-07-02T16:00:00.184Z","2022-07-03T16:00:00.184Z","2022-07-04T16:00:00.184Z","2022-07-05T16:00:00.184Z","2022-07-06T16:00:00.184Z","2022-07-07T16:00:00.184Z","2022-07-08T16:00:00.184Z","2022-07-09T16:00:00.184Z","2022-07-10T16:00:00.184Z","2022-07-11T16:00:00.184Z","2022-07-12T16:00:00.184Z","2022-07-13T16:00:00.184Z","2022-07-14T16:00:00.184Z","2022-07-15T16:00:00.184Z","2022-07-16T16:00:00.184Z","2022-07-17T16:00:00.184Z","2022-07-18T16:00:00.184Z","2022-07-19T16:00:00.184Z","2022-07-20T16:00:00.184Z","2022-07-21T16:00:00.184Z","2022-07-22T16:00:00.184Z","2022-07-23T16:00:00.184Z","2022-07-24T16:00:00.184Z","2022-07-25T16:00:00.184Z","2022-07-26T16:00:00.184Z","2022-07-27T16:00:00.184Z","2022-07-28T16:00:00.184Z","2022-07-29T16:00:00.184Z","2022-07-30T16:00:00.184Z","2022-07-31T16:00:00.184Z","2022-08-01T16:00:00.184Z","2022-08-02T16:00:00.184Z","2022-08-03T16:00:00.184Z","2022-08-04T16:00:00.184Z","2022-08-05T16:00:00.184Z","2022-08-06T16:00:00.184Z","2022-08-07T16:00:00.184Z","2022-08-08T16:00:00.184Z","2022-08-09T16:00:00.184Z","2022-08-10T16:00:00.184Z","2022-08-11T16:00:00.184Z","2022-08-12T16:00:00.184Z","2022-08-13T16:00:00.184Z","2022-08-14T16:00:00.184Z","2022-08-15T16:00:00.184Z","2022-08-16T16:00:00.184Z","2022-08-17T16:00:00.184Z","2022-08-18T16:00:00.184Z","2022-08-19T16:00:00.184Z","2022-08-20T16:00:00.184Z","2022-08-21T16:00:00.184Z","2022-08-22T16:00:00.184Z","2022-08-23T16:00:00.184Z","2022-08-24T16:00:00.184Z","2022-08-25T16:00:00.184Z","2022-08-26T16:00:00.184Z","2022-08-27T16:00:00.184Z","2022-08-28T16:00:00.184Z","2022-08-29T16:00:00.184Z","2022-08-30T16:00:00.184Z","2022-08-31T16:00:00.184Z","2022-09-01T16:00:00.184Z","2022-09-02T16:00:00.184Z","2022-09-03T16:00:00.184Z","2022-09-04T16:00:00.184Z","2022-09-05T16:00:00.184Z","2022-09-06T16:00:00.184Z","2022-09-07T16:00:00.184Z","2022-09-08T16:00:00.184Z",
        "2022-09-09T16:00:00.184Z","2022-09-10T16:00:00.184Z"

    ];


    let output = [];

    targetDataList.forEach(targetDate => {
        const array = getTimeData(targetDate);

    const startD = new Date(array[1]);
    const endD = new Date(array[2]);


    const format = 'YYYY-MM-DD HH:mm';

    const record = targetDate + "," + array[0] + "," + sampleDate(startD, format) + "," + sampleDate(endD, format) + "\n";

    // console.log(record);
    output.push(record);
});


    // console.log(output.join(""));

    const bodyData = output.join("");

    const fileNameDate = new Date();

    const keyName = "test_result_" + fileNameDate + ".csv"

    let s3Params = {
        Bucket: "my-bucket-lambda-test",
        Key: keyName,
        Body: bodyData
    };

    await s3.putObject(s3Params).promise();


    function sampleDate(date, format) {

        format = format.replace(/YYYY/, date.getFullYear());
        format = format.replace(/MM/, date.getMonth() + 1);
        format = format.replace(/DD/, date.getDate());
        format = format.replace(/HH/, date.getHours());
        format = format.replace(/mm/, date.getMinutes());


        return format;
    }



    /**
     * ログ取得の開始日時、終了日時、日付フォーマットを返す。
     * ログデータは、エクスポートできるようになるまで最大 12時間かかる場合があるので、
     * 1日前のログを取得するように日時を調整。
     * @return arr : [from, to, format]
     *
     */
    function getTimeData(targetDate) {
        let arr=[];
        let now = new Date(targetDate);
        now.setTime(now.getTime() + 1000*60*60*9);// JSTに変換);
        let yyyy,mm,dd;
        console.log(now);

        /* 開始日：fromをarrにセット */
        let startDate = new Date(targetDate);
        startDate.setTime(startDate.getTime() + 1000*60*60*9);// JSTに変換
        startDate.setDate(now.getDate() - Number(process.env.TargetFromDays));
        startDate.setHours(0);
        startDate.setMinutes(0);
        startDate.setSeconds(0);
        startDate.setMilliseconds(0);
        console.log(`ログ取得from：${startDate.getFullYear()}/${startDate.getMonth() + 1}/${startDate.getDate()} ${startDate.getHours()}:${startDate.getMinutes()}:${startDate.getSeconds()}.${startDate.getMilliseconds()}`);

        /* 終了日：toをarrにセット */
        let endDate = new Date(startDate);
        endDate.setFullYear(startDate.getFullYear());
        endDate.setMonth(startDate.getMonth());
        endDate.setDate(startDate.getDate());
        endDate.setHours(23);
        endDate.setMinutes(59);
        endDate.setSeconds(59);
        endDate.setMilliseconds(999);
        console.log(`ログ取得to：${endDate.getFullYear()}/${endDate.getMonth() + 1}/${endDate.getDate()} ${endDate.getHours()}:${endDate.getMinutes()}:${endDate.getSeconds()}.${endDate.getMilliseconds()}`);


        yyyy = startDate.getFullYear();
        /* 1~9月は01~09、10月~12月は10~12で表記するよう設定 */
        mm = ('0' + (startDate.getMonth() + 1)).slice(-2);
        dd = ('0' + startDate.getDate()).slice(-2);
        arr.push(`${yyyy}-${mm}-${dd}`);


        // リクエストはUTCで送る必要があるため、マイナス9時間する。
        startDate.setHours(startDate.getHours() - 9);
        endDate.setHours(endDate.getHours() - 9);
        console.log(startDate);
        console.log(endDate);

        arr.push(startDate.getTime());
        arr.push(endDate.getTime());

        return arr;
    }
};
